<!DOCTYPE html>

<html>
  <head>
    <title>Récupérer et visualiser les données d'avito.ma / Python + d3.js</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/prism.css" rel="stylesheet">
    <link href="css/styles.css?v=3" rel="stylesheet">
    <link href="css/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
      .chart {
        border: 1px solid #ccc;
      }
      .chart rect {
        fill: steelblue;
      }
      .chart text {
        fill: white;
        font: 10px sans-serif;
        text-anchor: end;
      }
      .axis text {
        font: 10px sans-serif;
        fill: #000;
      }
      .x.axis text {
        font: 11px sans-serif;
      }
      .axis path, .axis line {
        fill: none;
        stroke: #000;
        shapre-rendering: crispEdges;
      }
      .axis text.y_title {
        fill: #000;
        font-weight: bold;
      }
      .tooltip {
        top: 0;
        left: -1000px;
        position: absolute;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        width: 120px;
        text-align: center;
        background: #fff;
        opacity: .7;
      }

    </style>
  </head>
  <body>
    <header class="header_top">
      <h1><a href="index.html">I. RACHDI</a></h1>
    </header>
    <div class="container">
      <main>
        <article class="article_post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="page-header">
            <h1>
              <span itemprop="name">Récupérer et visualiser les données d'avito.ma / Python + d3.js</span>
              <time itemprop="datePublished" class="post_date" datetime="2015-09-06T12:40">6 Septembre 2015</time>
            </h1>
          </header>
          <div itemprop="articleBody" class="post_body">
            <p>
              On va voir comment extraire les données du site d'annonces <a href='http://avito.ma'>avito.ma</a>, dans notre cas, on va récupérer les données sur les appartements à vendre à Casablanca.
            </p>
            <p>
              Pour faire ceci, on va utiliser python v. 3, donc pensez à l'installer si vous ne l'avez pas déajà. On aura aussi besoin d'installer les modules suivants :</p>
            <ul>
              <li><a href="https://pypi.python.org/pypi/beautifulsoup4">BeautifulSoup</a>: pour pouvoir parcrourir le code HTML de la page, et extraire les données qui nous intéressent. <br><code class='language-bash'>pip3 install beautifulsoup4</code></li>
              <li><a href="https://pypi.python.org/pypi/requests/">requests</a>: pour exécuter les requêtes HTTP plus facilement. <br><code class='language-bash'>pip3 install requests</code></li>
            </ul>
            <h2>Envoyer la requête</h2>
            <p>
              L'URL pour faire une recherche sur avito est comme ceci: <code>http://www.avito.ma/fr/maroc/?ca=15&q=&cg=1010&w=1005&st=s&m=&m=&spr=&mpr=&o=1</code>. Il y a plusieurs paramètres, mais ceux qui nous intéressent sont: 
            </p>
            <ul>
              <li>cg:  la catégorie.</li>
              <li>w: la ville.</li>
              <li>s: Offre (vente) ou demande.</li>
              <li>o: numéro de la page dans les résultat de la recherche.</li>
            </ul>
            <p>
              Dans un premier temps, on va faire une recherche sur les appartements à vendre à casablanca, et récupérer la première page. Dans l'interpréteur python, on va entrer les instructions suivantes:
            </p>
            <pre><code class="language-python">>>>import requests

>>>url = "http://www.avito.ma/fr/maroc/?ca=15&q=&cg=1010&w=1005&st=s&m=&m=&spr=&mpr=&o=1"
>>>r = requests.get(url, allow_redirects=False)</code></pre>
            <p>
              On peut après récupérer la page HTML retournée avec la propriété text de l'objet retourné:
            </p>
            <pre><code class="language-python">>>>print(r.text)</code></pre>

            <h2>Extraction des données</h2>
            <p>Dans le texte qu'on a récupéré plus tôt, on a une liste d'appartements, et chaque élément de la liste contient un lien HTML qui pointe vers une page où on trouvera les détails de l'annonce. Ce qu'il nous faut maintenant c'est un moyen de récupérer l'url de chaque annonce.</p>
            <p>Pour ceci, on va utiliser le module <a href="https://pypi.python.org/pypi/beautifulsoup4">beautifulsoup4</a>. Ce module nous fournit un parser HTML/XML, et permets de rechercher facilement dans l'arbre HTML. Pour utiliser ce module, après l'avoir importé, il faut lui passer le code HTML qu'on peut parcourir.</p>
            
            <pre><code class="language-python">>>>from bs4 import BeautifulSoup as bs4

>>>html = bs4(r.text, 'html.parser')</code></pre>
            
            <p>L'objet récupéré nous permetra de sélectionner les éléments qui nous intéressent en utilisant des sélecteurs CSS. Dans notre cas on veut récupérer les liens des annonces. Si on examine le code HTML qu'on a récupéré plus haut, on remarquera que le cadre qui contient les annonces est un élément "div", qui a les classes suivantes "panel-main no-border-radius". Le lien des détails de l'annonce est un élémént "a", a comme parent un élément h2, qui a lui même comma parent un élément div qui a les classes "item-info ctext1 mls".</p>
            <p>Le module beautifulsoup nous facilite grandement la tâche pour récupérer les liens des annonces, il nous suffit de lui spécifier le sélecteur suivant ".panel-main.no-border-radius .item-info.ctext1.mls h2 a".</p>
            
            <pre><code class="language-python">>>>liens = html.select('.panel-main.no-border-radius .item-info.ctext1.mls h2 a')</code></pre>
            
            <p>La méthode select retourne la liste des éléments qui sont identifiés par le sélecteur passé en argument. On peut ainsi boucler sur cette liste, et récupérer l'attribut href de chaque lien récupéré.</p>
            <pre><code class="language-python">>>>for lien in liens:
...  print(lien['href'])</code></pre>
            
            <div id='barchart'>
              <svg class='chart'></svg>
            </div>
          </div>
        </article>
      </main>
    </div>
    <div class="tooltip"></div>
    <script src="js/d3.min.js"></script>
    <script>
      var locale = d3.locale({
        "decimal": ",",
        "thousands": " ",
        "grouping": [3],
        "currency": ["$", ""],
        "dateTime": "%a %b %e %X %Y",
        "date": "%m/%d/%Y",
        "time": "%H:%M:%S",
        "periods": ["AM", "PM"],
        "days": ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        "shortDays": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        "months": ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        "shortMonths": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
      })
      var moyenne_total = 13811.404446284374;

      var margin = {top: 20, right: 30, bottom: 120, left: 50},
      chart_width = 960 - margin.left - margin.right,
              chart_height = 500 - margin.top - margin.bottom;

      var y_scale = d3.scale.linear().range([chart_height, 0]);
      var x_scale = d3.scale.ordinal().rangeRoundBands([0, chart_width], .1);

      var chart = d3.select('.chart')
              .attr('width', chart_width + margin.left + margin.right)
              .attr('height', chart_height + margin.right + margin.bottom)
              .append('g')
              .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');

      d3.text("data/prix_par_metre_casa.csv", "text/csv", function (error, content) {
        var dsv = d3.dsv(";", "text/csv");
        var data = dsv.parseRows(content, function (d) {
          d[1] = +d[1];
          d[2] = +d[2];
          return d;
        });
        x_scale.domain(data.map(function (d) {
          return d[0];
        }));
        y_scale.domain([0, d3.max(data, function (d) {
            return d[1];
          })]);

        var x_axis = d3.svg.axis()
                .scale(x_scale)
                .orient('bottom');

        var y_axis = d3.svg.axis()
                .scale(y_scale)
                .orient("left");

        var bars = chart.selectAll('g')
                .data(data)
                .enter().append('g')
                .attr('transform', function (d, i) {
                  return 'translate(' + x_scale(d[0]) + ', 0)';
                });
        var formatNumber = locale.numberFormat(',.2f');
        bars.append('rect')
                .attr('y', function (d) {
                  return y_scale(d[1]);
                })
                .attr('height', function (d) {
                  return chart_height - y_scale(d[1]);
                })
                .attr('width', x_scale.rangeBand())
                .on('mouseover', function (d) {
                  d3.select('.tooltip')
                          .style('top', d3.event.pageY + 'px')
                          .style('left', d3.event.pageX + 'px')
                          //                  .text(d[1].toFixed(2)))
                          .text(formatNumber(d[1]));
                })
                .on('mouseleave', function (d) {
                  d3.select('.tooltip')
                          .style('left', '-1000px')
                          .text('');
                });

        chart.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(0, ' + chart_height + ')')
                .call(x_axis)
                .selectAll('text')
                .style('text-anchor', "end")
                .attr('dx', '-1em')
                .attr('dy', '-0.5em')
                .attr('transform', 'rotate(-70)');

        chart.append('g')
                .attr('class', 'y axis')
                .call(y_axis)
                .append("text")
                .attr('class', 'y_title')
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Dhs");

      });
    </script>
    <script src="js/prism.js"></script>
  </body>
</html>
